# ИДЗ 2

**Выполнил:** Тимергалин Тимур Маратович, БПИ 227

**Предполагаемая оценка:** 10

## Условие

Задача о курильщиках. Есть три процесса–курильщика и один процесс–посредник. Курильщик непрерывно скручивает сигареты и курит их. Чтобы скрутить сигарету, нужны табак, бумага и спички. У одного курильщика есть табак, у второго — бумага, а у третьего – спички. Посредник через некоторое случайное время кладет на стол по два разных случайных компонента. Тот Курильщик, у которого есть третий компонент, забирает компоненты со стола, скручивает сигарету и курит некоторое случайное время. Посредник через отведенный ему интервал времени, который может быть больше или меньше времени курения, выкладывает следующий набор. Если курильщик, которому нужен этот набор, свободен, то он начинает курить. Если курильщик еще курит, то процесс передачи дожидается окончания курения. Затем процесс повторяется. В принципе возможна ситуация, когда все три курильщика могут курить одновременно или все могут ждать, когда посредник соизволит выложить очередной набор.

## Решение

### Процессы

В условии указано, что курильщиков 3, однако решение работает для произвольного числа курильщиков. Назовем его n. Приложение состоит из 4 + n процессов (фактически, только 3 + n из них делает что-то содержательное):

- Мастер-процесс. Запускается первым. Создает все разделяемые данные, используемые в приложении, отвечает за их удаление;
- Процесс-производитель. Со случайной периодичностью (но фиксированной на протяжении работы программы) создает n - 1 ресурс для курения и пересылает их процессу-посреднику;
- n процессов-курильщиков. Ждут от посредника ресурсы на курение, затем курят случайное (но фиксированное на протяжении работы программы) время. Все процессы-курильщики - дети одного процесса-родителя (это сделано для удобства их одновременного запуска). Процесс-родитель просто ждет завершения процессов детей;
- Процесс-посредник. Принимает от курильщиков запросы на ресурсы, а от производителя, на их поставку. Отвечает за хранение текущего количества ресурсов. 

Далее процессы производителя, посредника и курильщиков будем в совокупности называть рабочими процессами.

### Взаимодействие процессов

Цикл жизни программы можно разделить на 3 этапа: инициализация, основная работа и завершение.

#### Инициализация

Инициализация проходит по следующей схеме:

1. Мастер-процесс создает все разделяемые ресурсы, необходимые для работы приложения;
2. Мастер-процесс ожидает по специально отведенному каналу получить pid-ы всех 2 + n рабочих процессов;
3. Рабочие процессы отправляют по каналу свой pid;
4. Рабочие процессы ожидают от мастер-процесса разрешение на начало работы;
5. После того, как мастер-процесс получит 2 + n pid-ов, в специально отведенный канал будет послано 2 + n сообщений о разрешении работы;
6. Каждый рабочий процесс после получения разрешения от мастер-процесса начинает работу;
7. Инициализация завершена.

#### Основная работа

Основная работа приложения совершается по следующей схеме:

1. Курильщики запрашивают у посредника ресурсы для курения по каналу для запросов; запрос представляет из себя номер ресурса, которым обладает курильщик. После отправки запроса, курильщики начинают ожидать ответа от посредника, для каждого курильщика отведен специальный канал для ответа;
2. Производитель начинает производить ресурсы (ждать);
3. Когда производитель заканчивает производить ресурсы, он отправляет по каналу для запросов запрос посреднику, чтобы тот принял доставку из канала для доставки ресурсов; запрос представляет из себя число, отличное от номеров ресурсов (чтобы можно было отличить запрос производителя от запросов курильщиков). Затем он начинает производить новую партию;
4. Посредник ждет запросы от других потоков. Когда приходит запрос от курильщика, номер соответствующего ресурса добавляется в очередь, когда приходит запрос от производителя, ресурсы считываются из канала для доставки ресурсов и добавляются к общей "куче". После обработки любого запроса, посредник проходится по очереди курильщиков, и обслуживает всех курильщиков, на кого хватает ресурсов - курильщикам отправляется разрешение на курение, ресурсы вычитаются из общей "кучи";
5. После получения разрешения курильщики начинают курить (ждать). После завершения, они снова отправляют запрос посреднику.

Без прерывания извне приложение никогда не останавливается.

#### Завершение

Завершение может проходить по двум сценариям: нормальному и досрочному.

Завершение по нормальному сценарию происходит следующим образом:

1. Когда рабочий процесс получает сигнал `SIGINT`, `SIGTERM` или `SIGQUIT`, мастер-процессу по каналу отправляется pid рабочего процесса, затем процесс заканчивает работу;
2. Мастер-процесс регистрирует завершение процесса. Как только все рабочие процессы заявят о своем завершении, мастер-процесс удалит все разделяемые ресурсы и завершит работу.
3. Все процессы завершили свою работу.

Завершение по досрочному сценарию происходит, когда сигнал `SIGINT`, `SIGTERM` или `SIGQUIT` получает мастер-процесс. В этом случае, мастер-процесс отправляет сигнал `SIGUSR1` всем рабочим процессам, которые не заявили о своем завершении. После этого мастер процесс удаляет все разделяемые ресурсы и завершает работу. Рабочие процессы при получении `SIGUSR1` завершают работу.

## Реализация

### Структура решения

```
│   choose_out.h
│   CMakeLists.txt
│   constants.h
│   empty.h
│   handshake.h
│   master.cpp
│   merge_outputs.py
│   producer.cpp
│   README.md
│   resources.cpp
│   smokers.cpp
│   SyncCout.h
│
├───name_generator
│       NameGenerator.cpp
│       NameGenerator.h
│
├───pipe
│       base.h
│       get.h
│       posix_mq_based.cpp
│       semaphore_based.cpp
│       sysv_mq_based.cpp
│
├───semaphore
│       base.h
│       get.h
│       posix_named.cpp
│       posix_unnamed.cpp
│       sysv.cpp
│
├───shared_memory
│       base.h
│       get.h
│       posix.cpp
│       sysv.cpp
│
└───tests
|		...
```

### Описание

#### Основные файлы

Приложение реализовано на C++. На каждую оценку (версии 45, 67, 8, 9, 10) в CMakeList.txt присутствует по 4 исполняемые единицы - `master` (мастер-процесс), `resources` (посредник), `producer` (производитель), `smokers` (курильщики). В независимости от версии в основе исполняемых единиц лежат файлы `master.cpp`, `resources.cpp`, `producer.cpp` и `smokers.cpp`. Дело в том, что работа с разделяемыми данными происходит посредством интерфейсов (`shm::Base` для разделяемой памяти, `sem::Base` для семафоров, `pipes::Base` для каналов, определены в `*/base.h`). Конкретные реализации этих классов определяются тем, какие файлы будут участвовать в процессе компиляции. 

У `sem::Base` есть 3 реализации: на основе неименованного *posix*-семафора (`posix_unnamed.cpp`), именованного *posix*-семафора (`posix_named.cpp`) и на основе *sysV*-семафора (`sysv.cpp`). Все файлы лежат в папке `semaphore`.

 У `shm::Base` есть 3 реализации: на основе разделяемой памяти *posix* (`posix.cpp`) и на основе разделяемой памяти *sysV* (`sysv.cpp`). Все файлы лежат в папке `shared_memory`.

У каналов есть 3 реализации: на основе семафоров и разделяемой памяти (`semaphore_based.cpp`) - по поведению не отличается от очереди сообщений с буфером на одно сообщение; на основе очереди сообщений *posix* и *sysV* (`posix_mq_based.cpp` и `sysv_mq_based.cpp` соответственно). Все файлы лежат в папке `pipe`.

#### Прочие файлы

В решении также присутствуют следующие файлы:

- `choose_out.h` - функции для обработки аргументов командной строки;
- `constants.h` - файл с константами. Среди них есть константа `smokers_count`. Её можно изменить, чтоб поменять количество курильщиков (и ресурсов);
- `empty.h` - файл с определением пустой структуры - она нужна для отправки пустых сообщений;
- `handshake.h` - функции для инициализации рабочих процессов;
- `merge_outputs.py` - скрипт для упрощения проверки (см. Тестирование)
- `SyncCout.h` - файл с определением обертки над выходным потоком с синхронизацией (нужен для синхронизации вывода курильщиков - у них общая консоль);
- `name_generator/NameGenerator.(h|cpp)` - файл с определением генератора имен - нужен для того, чтобы каждый процесс мог независимо получить одни и те же имена для одних и тех же разделяемых ресурсов;
- `(semaphore|shared_memory|pipe)/get.h` - функции для получения экземпляра реализации соответствующего интерфейса;
- `tests` - папка с результатами запусков.

### Запуск

Каждая исполняемая единица принимает 1 опциональный аргумент командной строки - путь к файлу для вывода результата. Если путь к файлу не передан, будет использоваться стандартный поток вывода.

Мастер-процесс обязательно нужно запустить первым - чтобы каналы для передачи ему pid-ов были проинициализированы (это важно при использовании каналов на основе семафоров). Остальные процессы можно запускать в любом порядке.

## Тестирование

Результаты работы каждой версии приложения записаны в соответствующей подпапке `tests`. Результаты приведены для двух сценариев завершения. Для упрощения проверки, выводы разных процессов были объединены в один с помощью скрипта `merge_outputs.py`. Записи в нем отсортированы по порядку появления - для этого используется unix-timestamp (стоит отметить, что некоторые события происходили так быстро, что их timestamp-ы одинаковые, из-за этого порядок может незначительно отличаться от реального). 
